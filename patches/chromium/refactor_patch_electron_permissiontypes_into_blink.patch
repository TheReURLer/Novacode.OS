From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Charles Kerr <charles@charleskerr.com>
Date: Thu, 17 Apr 2025 19:07:23 -0500
Subject: refactor: patch electron PermissionTypes into blink

6387077: [PermissionOptions] Generalize PermissionRequestDescription | https://chromium-review.googlesource.com/c/chromium/src/+/6387077

diff --git a/components/permissions/permission_util.cc b/components/permissions/permission_util.cc
index 56ff4f1b5a0f2e71e63c594d47a19894e3ea1fea..28e1b98d21a26c5c62b298cd0bf89a17a29c102d 100644
--- a/components/permissions/permission_util.cc
+++ b/components/permissions/permission_util.cc
@@ -548,7 +548,17 @@ ContentSettingsType PermissionUtil::PermissionTypeToContentSettingsTypeSafe(
       return ContentSettingsType::LOCAL_NETWORK;
     case PermissionType::LOOPBACK_NETWORK:
       return ContentSettingsType::LOOPBACK_NETWORK;
+
+    // Permissions added by Electron
     case PermissionType::DEPRECATED_SYNC_CLIPBOARD_READ:
+    case PermissionType::ELECTRON_FULLSCREEN:
+    case PermissionType::FILE_SYSTEM:
+    case PermissionType::HID:
+    case PermissionType::OPEN_EXTERNAL:
+    case PermissionType::SERIAL:
+    case PermissionType::USB:
+      break;
+
     case PermissionType::NUM:
       break;
   }
diff --git a/content/browser/permissions/permission_controller_impl.cc b/content/browser/permissions/permission_controller_impl.cc
index 6efcec3647c8861b49c4c335aa4c04b7631d97d6..b3872734774b274c63a187366f072becbe3cee03 100644
--- a/content/browser/permissions/permission_controller_impl.cc
+++ b/content/browser/permissions/permission_controller_impl.cc
@@ -96,7 +96,15 @@ PermissionToSchedulingFeature(PermissionType permission_name) {
     case PermissionType::LOCAL_NETWORK_ACCESS:
     case PermissionType::LOCAL_NETWORK:
     case PermissionType::LOOPBACK_NETWORK:
+
+    // Permissions added by Electron
     case PermissionType::DEPRECATED_SYNC_CLIPBOARD_READ:
+    case PermissionType::FILE_SYSTEM:
+    case PermissionType::ELECTRON_FULLSCREEN:
+    case PermissionType::HID:
+    case PermissionType::OPEN_EXTERNAL:
+    case PermissionType::SERIAL:
+    case PermissionType::USB:
       return std::nullopt;
   }
 }
diff --git a/content/browser/permissions/permission_descriptor_util.cc b/content/browser/permissions/permission_descriptor_util.cc
index c9fab18af1135b5ae3ab014ec4786e766d730df3..cf4049c215761e081efc465f41ea30ad83632232 100644
--- a/content/browser/permissions/permission_descriptor_util.cc
+++ b/content/browser/permissions/permission_descriptor_util.cc
@@ -177,9 +177,27 @@ content::PermissionDescriptorUtil::CreatePermissionDescriptorForPermissionType(
     case blink::PermissionType::LOOPBACK_NETWORK:
       return CreatePermissionDescriptor(
           blink::mojom::PermissionName::LOOPBACK_NETWORK);
+
+    // Permissions added by Electron
     case blink::PermissionType::DEPRECATED_SYNC_CLIPBOARD_READ:
       return CreatePermissionDescriptor(
           blink::mojom::PermissionName::DEPRECATED_SYNC_CLIPBOARD_READ);
+    case blink::PermissionType::FILE_SYSTEM:
+      return CreatePermissionDescriptor(
+          blink::mojom::PermissionName::FILE_SYSTEM);
+    case blink::PermissionType::ELECTRON_FULLSCREEN:
+      return CreatePermissionDescriptor(
+          blink::mojom::PermissionName::ELECTRON_FULLSCREEN);
+    case blink::PermissionType::HID:
+      return CreatePermissionDescriptor(blink::mojom::PermissionName::HID);
+    case blink::PermissionType::OPEN_EXTERNAL:
+      return CreatePermissionDescriptor(
+          blink::mojom::PermissionName::OPEN_EXTERNAL);
+    case blink::PermissionType::SERIAL:
+      return CreatePermissionDescriptor(blink::mojom::PermissionName::SERIAL);
+    case blink::PermissionType::USB:
+      return CreatePermissionDescriptor(blink::mojom::PermissionName::USB);
+
     case blink::PermissionType::NUM:
       NOTREACHED();
   }
diff --git a/third_party/blink/common/permissions/permission_utils.cc b/third_party/blink/common/permissions/permission_utils.cc
index 6be9fce8f8d0e6b377cf670ff540b3457698cfb9..b3b61b89cc75e1164321aba9a94668df45106051 100644
--- a/third_party/blink/common/permissions/permission_utils.cc
+++ b/third_party/blink/common/permissions/permission_utils.cc
@@ -108,6 +108,18 @@ std::string GetPermissionString(PermissionType permission) {
       return "LoopbackNetwork";
     case PermissionType::DEPRECATED_SYNC_CLIPBOARD_READ:
       return "DeprecatedSyncClipboardRead";
+    case PermissionType::FILE_SYSTEM:
+      return "FileSystem";
+    case PermissionType::ELECTRON_FULLSCREEN:
+      return "Fullscreen";
+    case PermissionType::HID:
+      return "HID";
+    case PermissionType::OPEN_EXTERNAL:
+      return "OpenExternal";
+    case PermissionType::SERIAL:
+      return "Serial";
+    case PermissionType::USB:
+      return "USB";
     case PermissionType::NUM:
       NOTREACHED();
   }
@@ -186,7 +198,15 @@ PermissionTypeToPermissionsPolicyFeature(PermissionType permission) {
     // LOCAL_NETWORK and LOOPBACK_NETWORK
     case PermissionType::LOCAL_NETWORK:
     case PermissionType::LOOPBACK_NETWORK:
+
+    // Permissions added by Electron
     case PermissionType::DEPRECATED_SYNC_CLIPBOARD_READ:
+    case PermissionType::ELECTRON_FULLSCREEN:
+    case PermissionType::FILE_SYSTEM:
+    case PermissionType::HID:
+    case PermissionType::OPEN_EXTERNAL:
+    case PermissionType::SERIAL:
+    case PermissionType::USB:
       return std::nullopt;
 
     case PermissionType::NUM:
@@ -360,6 +380,21 @@ std::optional<PermissionType> PermissionDescriptorInfoToPermissionType(
       return PermissionType::WEB_PRINTING;
     case PermissionName::SMART_CARD:
       return PermissionType::SMART_CARD;
+    // Permissions added by Electron
+    case PermissionName::DEPRECATED_SYNC_CLIPBOARD_READ:
+      return PermissionType::DEPRECATED_SYNC_CLIPBOARD_READ;
+    case PermissionName::FILE_SYSTEM:
+      return PermissionType::FILE_SYSTEM;
+    case PermissionName::ELECTRON_FULLSCREEN:
+      return PermissionType::ELECTRON_FULLSCREEN;
+    case PermissionName::HID:
+      return PermissionType::HID;
+    case PermissionName::OPEN_EXTERNAL:
+      return PermissionType::OPEN_EXTERNAL;
+    case PermissionName::SERIAL:
+      return PermissionType::SERIAL;
+    case PermissionName::USB:
+      return PermissionType::USB;
   }
 }
 
diff --git a/third_party/blink/public/common/permissions/permission_utils.h b/third_party/blink/public/common/permissions/permission_utils.h
index 62503eb9dbfdbd2a0a1629a63946cb7010d40073..ace46b9dd2b5eca7d12645003a74b13df56aae6c 100644
--- a/third_party/blink/public/common/permissions/permission_utils.h
+++ b/third_party/blink/public/common/permissions/permission_utils.h
@@ -67,7 +67,17 @@ enum class PermissionType {
   LOCAL_NETWORK_ACCESS = 43,
   LOCAL_NETWORK = 44,
   LOOPBACK_NETWORK = 45,
-  DEPRECATED_SYNC_CLIPBOARD_READ = 44,
+  DEPRECATED_SYNC_CLIPBOARD_READ = 46,
+
+  // Permissions added by Electron
+  ELECTRON_FIRST = 47,
+  FILE_SYSTEM = ELECTRON_FIRST,
+  ELECTRON_FULLSCREEN,
+  HID,
+  OPEN_EXTERNAL,
+  SERIAL,
+  USB,
+  ELECTRON_LAST = USB,
 
   // Always keep this at the end.
   NUM,
diff --git a/third_party/blink/public/mojom/permissions/permission.mojom b/third_party/blink/public/mojom/permissions/permission.mojom
index 7bcd8e1f74a7d40722b2079201139d98cd1008d6..eb66e40d5a587be9f7140ad7fefd57d674fed3aa 100644
--- a/third_party/blink/public/mojom/permissions/permission.mojom
+++ b/third_party/blink/public/mojom/permissions/permission.mojom
@@ -46,7 +46,15 @@ enum PermissionName {
   HAND_TRACKING,
   WEB_PRINTING,
   SMART_CARD,
-  DEPRECATED_SYNC_CLIPBOARD_READ
+
+  // Permissions added by Electron
+  DEPRECATED_SYNC_CLIPBOARD_READ,
+  FILE_SYSTEM,
+  ELECTRON_FULLSCREEN,
+  HID,
+  OPEN_EXTERNAL,
+  SERIAL,
+  USB
 };
 
 struct MidiPermissionDescriptor {
diff --git a/third_party/blink/renderer/modules/permissions/permission_utils.cc b/third_party/blink/renderer/modules/permissions/permission_utils.cc
index 96c34df070c43b7db9c97073473d770d7af080fb..17775a89e6bdaefb2e894d57705a3c7723ac1f30 100644
--- a/third_party/blink/renderer/modules/permissions/permission_utils.cc
+++ b/third_party/blink/renderer/modules/permissions/permission_utils.cc
@@ -149,8 +149,22 @@ String PermissionNameToString(PermissionName name) {
       return "web-printing";
     case PermissionName::SMART_CARD:
       return "smart-card";
+
+    // Permissions added by Electron
     case PermissionName::DEPRECATED_SYNC_CLIPBOARD_READ:
       return "deprecated-sync-clipboard-read";
+    case PermissionName::FILE_SYSTEM:
+      return "file-system";
+    case PermissionName::ELECTRON_FULLSCREEN:
+      return "electron-fullscreen";
+    case PermissionName::HID:
+      return "hid";
+    case PermissionName::OPEN_EXTERNAL:
+      return "open-external";
+    case PermissionName::SERIAL:
+      return "serial";
+    case PermissionName::USB:
+      return "usb";
   }
 }
 
